# 컨텍스트 스위칭 (Context switch)

**컨텍스트 스위칭**이란 현재 실행되고 있던 프로세스/쓰레드의 상태를 저장하고 **CPU**를 다른 프로세스/쓰레드로 
넘겨주는 것이다. 이때 프로세스/쓰레드의 상태를 컨텍스트라고 한다. 

<br>

## Q) 컨텍스트 스위칭이 발생할 때, 기존의 프로세스 정보는 커널스택에 어떠한 형식으로 저장되나요?

### 컨텍스트

* `프로세스 상태`: 생성, 준비, 수행, 대기, 중지
* `프로세스 번호(PID)`
* `프로그램 카운터`
* `레지스터`
* `메모리 제한`
* `열린 파일 정보`

컨텍스트는 CPU가 해당 프로세스를 실행하기 위한 정보들이다. 컨텍스트 스위칭을 하기 위해서 이 정보들을 프로세스의 **PCB**(Process Control Block)에 저장한다. 
프로세스가 생성되면 메모리에 해당 프로세스의 PCB가 함께 생성되고, 종료시 삭제된다.  


## Q) 프로세스와 쓰레드는 컨텍스트 스위칭이 발생했을 때 어떤 차이가 있을까요?

* `프로세스 컨텍스트 스위칭`: 현재 실행중인 프로세스의 쓰레드와는 다른 프로세스의 쓰레드와 컨텍스트 스위칭이 발생
* `쓰레드 컨텍스트 스위칭`: 같은 프로세스 안의 쓰레드 끼리 컨텍스트 스위칭이 발생
  

둘의 공통점은 커널 모드에서 실행된다는 점이다.  

쓰레드는 스택 영역을 제외한 모든 메모리 영역을 공유하기 때문에 메모리 주소 관련한 정보는 바꿀 필요가 없고, CPU의 상태정보만 바꿔주면 된다.  
다시 말해 쓰레드 컨텍스트 스위칭은 공유하는 정보가 많아 프로세스 컨텍스트 스위칭보다 더 빨리 수행될 수 있다.  

프로세스 컨텍스트 스위칭이 발생하면 **캐시 오염**(cache pollution) 이 발생하게 된다.  
프로세스가 변경되어 새로운 프로세스가 CPU를 사용하는데 캐시에는 이전 프로세스에서 사용하던 전혀 다른 데이터에 대한 캐시가 남는다. 
이를 캐시 오염이라 부른다.  


## Q) 컨텍스트 스위칭은 언제 일어날까요?

1. I/O 인터럽트
2. CPU 사용시간 만료
3. 인터럽트 처리를 기다릴 때


## Q) 컨텍스트 스위칭시에는 어떤 일들이 일어날까요?

프로세스 A: `running`  
프로세스 B: `ready`

1. 스케줄러가 프로세스 A와 프로세스 B의 컨텍스트 스위칭 요청
2. 프로세스 A의 컨텍스트를 PCB A에 저장
3. 프로세스 A의 상태는 `ready` 혹은 `block`으로 변경, 프로세스 B의 상태는 `running`으로 변경 (Dispatch)
4. 다시 프로세스 A를 실행시킬때에는 PCB A에서 정보들을 가져와 실행
