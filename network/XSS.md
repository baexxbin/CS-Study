# XSS

* XSS란 Cross Site Scripting의 약자로, 웹 어플리케이션에서 많이 발생하는 취약점 중 하나이다.
* CSS(Cascading Style Sheets)과 이름이 혼돈될 수 있어 XSS라고 부른다.
* XSS는 웹 어플리케이션에서 입력값을 검증하지 않고 사용할 때 발생한다.
* 이 취약점으로 인해 공격자는 웹 어플리케이션을 통해 공격대상자의 쿠키를 탈취하거나, 공격대상자의 계정을 탈취할 수 있다.

<br>

## 공격 유형

### Stored XSS (저장형 크로스사이트 스크립팅)

* 공격자의 악성스크립트가 데이터베이스에 저장되고 이 값을 출력하는 페이지에서 피해가 발생하는 취약점이다.
* 공격자는 악성스크립트가 포함된 게시물을 작성하여 게시판 등 사용자가 접근할 수 있는 페이지에 업로드한다.
* 이때 사용자가 악성스크립트가 포함된 게시물을 요청하면, 공격자가 삽입한 악성스크립트가 사용자 측에서 동작한다.
* 공격자의 악성스크립트가 서버에 저장되어 불특정 다수를 대상으로 공격에 이용될 수 있어 Reflected XSS보다 공격 대상의 범위가 훨씬 크다.

#### 공격 과정

* 공격자가 게시판에 악성스크립트가 포함된 게시물을 작성한다.
  * `<script>alert('악성스크립트');</script>`
* 사용자가 게시판에 접근하여 게시물을 요청한다.
* 서버는 공격자가 삽입한 악성스크립트 응답

<br>

<img alt="Stored XSS" height="300" src="https://github.com/reddevilmidzy/CS-Study/assets/78539407/94212b08-2c8f-49ca-80bb-225bf823f918"/>

<br>


### Reflected XSS (반사형 크로스사이트 스크립팅)

* 사용자가 요청한 악성스크립트가 사용자측에서 반사되어 동작하는 취약점으로, 공격자의 악성스크립트가 데이터베이스와 같은 저장소에 별도로 저장되지 않고 사용자의 화면에 즉시 출력되면서 피해가 발생한다.
* 공격자는 악성스크립트가 포함된 URL을 이메일, 메신저 등을 통해 사용자가 클릭할 수 있도록 유도한다.
* 사용자가 악성스크립트가 삽입된 URL을 클릭하거나 공격자에 의해 악의적으로 조작된 게시물을 클릭했을 때 사용자의 브라우저에서 악성스크립트가 실행된다.

#### 공격 과정

* 공격자는 검색 결과를 응답하는 파라미터를 확인
  * `http://www.example.com/search?query=도서`
* 공격자는 검색 결과를 응답하는 파라미터에 악성스크립트를 삽입
  * `http://www.example.com/search?query="><script>alert('악성스크립트');</script>`
* 서버는 공격자가 삽입한 악성스크립트 응답


<br>

<img alt="Reflected XSS" height="300" src="https://github.com/reddevilmidzy/CS-Study/assets/78539407/329c0ed1-f877-4aef-bbb8-d682be5c8105"/>

<br>


### DOM-based XSS (DOM 기반 크로스사이트 스크립팅)

* 공격자의 악성스크립트가 DOM 영역에서 실행됨으로써 서버와의 상호작용 없이 브라우저 자체에서 악성스크립트가 실행되는 취약점이다.
* DOM 영역에 변화가 생기면 브라우저는 서버로 패킷을 보내지 않고 DOM 영역에서 페이지를 변환시킨다.
* 따라서 DOM의 일부로 실행되기 때문에 브라우저 자체에서 악성스크립트가 실행되는 것이다.
* Stored XSS와 Reflected XSS는 서버에서 악성스크립트가 실행되고 공격이 이뤄지는 반면에 DOM Based Xss는 서버와 상호작용 없이 브라우저에서 악성스크립트가 실행되고 공격이 이뤄진다.

<br>

<img alt="DOM-based XSS" height="300" src="https://github.com/reddevilmidzy/CS-Study/assets/78539407/34e29f43-4caa-40d3-b27b-ca8ee7e2e275"/>

<br>

> DOM(Document Object Model)이란? <br>
> HTML, XML 문서의 프로그래밍 interface이다. <br>
> DOM은 문서의 구조화된 표현을 제공하며, 프로그래밍 언어가 DOM 구조에 접근할 수 있는 방법을 제공하여 그들이 문서 구조, 스타일, 내용 등을 변경할 수 있게 돕는다. <br>


<br>


<br>



# CSRF

* CSRF란 Cross Site Request Forgery의 약자로, 웹 어플리케이션에서 많이 발생하는 취약점 중 하나이다.
* XSS를 이용한 공격이 사용자가 특정 웹사이트를 신용하는 점을 노린 것이라면, CSRF는 특정 웹사이트가 사용자의 웹 브라우저를 신용하는 상태를 노린 것이다.
* 사용자가 웹사이트에 로그인한 상태에서 CSRF 공격 코드가 삽입된 페이지를 열면, 공격 대상이 되는 웹사이트는 위조된 공격 명령이 믿을 수 있는 사용자로부터 발송된 것으로 판단하게 되어 공격에 노출된다.


<br>

## CSRF 동작 원리

* CSRF 공격에 성공하기 위해서는 공격 대상 페이지의 로직을 분석하여 파라미터의 전송 형태와 기능을 파악해야 한다.
* 이후 공격자는 피해자가 서버로 HTTP 요청을 보내도록 유도하는 스크립트를 작성하여, 피해자가 해당 스크립트를 읽었을 때 공격이 발생하도록 한다.
* 피해자는 자신의 권한으로 서버에 공격자가 의도한 악의적인 요청을 보내게 되는데, 이 때 사용자에 대한 검증 로직이 미흡할 경우 공격이 성공하게 된다.
* 공격 대상의 권한에 따라 공격자가 의도한 행위가 수행되기 때문에 공격 대상이 관리자일 경우, 피해를 가중시킬 수 있다.  

<br>

## CSRF 공격 예시

* 공격자는 피해자가 접속할 수 있는 게시판에 악성스크립트가 포함된 게시물을 작성한다.
* 예를 들어 패스워드 변경 페이지에서 패스워드 변경 요청을 보내면 다음과 같은 파라미터를 전송하여 패스워드가 변경된다고 하자.
    * `http://www.example.com/changepassword/modAction.jsp?new_pw1="변경할패스워드"&new_pw2="패스워드확인"&action=change`
* 공격자는 자신이 원하는 패스워드로 변경을 유도하는 CSRF 스크립트를 작성하여 게시글을 등록한다.
* 피해자는 공격자가 등록한 CSRF 스크립트가 삽입된 게시글에 접근하면 피해자 측에서 패스워드 변경 스크립트가 동작하여 피해자의 패스워드가 변경된다.
* 이후 공격자는 피해자의 패스워드를 알고 있으므로 피해자의 계정을 탈취할 수 있다.


<br>

<br>

# XSS와 CSRF의 차이점

* XSS의 경우 불특정 다수의 클라이언트를 대상으로 공격하지만, CSRF는 서버를 대상으로 공격을 진행한다.
* 즉 공격자에 의해 삽입된 스크립트가 서버에서 실행되는지, 클라이언트 측에서 실행되는지에 따라 구별할 수 있다.
* XSS는 클라이언트 측에서 동작하여 클라이언트의 정보 탈취에 목적이 있지만, CSRF는 공격 대상의 권한을 통해 공격자가 원하는 요청을 보내는 공격이므로 공격자의 의도대로 서버가 동작하게끔 유도한다.


<br>

|  구분   |               XSS                |              CSRF               |
|:-----:|:--------------------------------:|:-------------------------------:|
| 발생 원인 |       클라이언트가 웹 서버를 신용하여 발생       |      웹 서버가 클라이언트를 신용하여 발생       |
| 공격 대상 |              클라이언트               |               서버                |
| 공격 목적 |     쿠키/ 세션 탈취, 악성 사이트로의 이동 등     |  권한 도용, 권한 상승 등 공격자가 원하는 행위 수행  |
| 공격 행위 | 악의적인 스크립트 작성하여 페이지에 포함시킨 후 실행 유도 | 서버에서 제공하는 기능을 페이지에 포함시킨 후 실행 유도 |

<br>

# 보안 대책 및 우회 기법

<br>

### XSS 필터링

**보안 기법**

* XSS 취약점은 공격자가 삽입한 악성스크립트로 인해 발생하기 때문에 입력값 검증을 통해 악성스크립트가 삽입되는 것을 방지해야한다.
* 또한 악성스크립트가 입력되어도 동작하지 않도록 출력값을 무효화해야 한다.
* 입력값 필터링의 경우 데이터베이스에 악성스크립트가 저장되는 것을 원천적으로 차단해야 한다.
* 악성스크립트를 검증하여 스크립트에 사용되는 특수문자를 HTML Entity로 치환하여 응답하도록 한다.


| 특수문자        | `<`     | `>`     | `'`       | `"`       | `(`       | `)`       |
|-------------|---------|---------|-----------|-----------|-----------|-----------|
| HTML Entity | `& lt;` | `& gt;` | `& apos;` | `& quot;` | `& lpar;` | `& rpar;` |


<br>

```java
String searchWord = request.getParameter("searchWord");
if (searchWord != null) {
    searchWord = searchWord.replaceAll("<","&lt;");
    searchWord = searchWord.replaceAll(">","&gt;");
    searchWord = searchWord.replaceAll("(","&lpar;");
    searchWord = searchWord.replaceAll(")","&rpar;");
}

```

<br>

**우회 기법**

* 필터링 규칙이 미흡할 경우 필터링 우회 가능성이 존재한다.
* 외부 사이트에서 실행되어 요청을 보내는 경우 공격이 발생할 수 있다.

<br>

### GET/POST 구분

**보안 기법**

* GET 메서드 허용 시 단순 URL로도 공격이 가능하며, 이는 POST 메서드를 사용하여 막을 수 있다. 

**우회 기법**

* POST 요청을 보내는 스크립트를 작성하여 우회가 가능하다.

<br>

### 보안 토큰 사용

**보안 기법**

* 중요 기능 동작 시 랜덤으로 발행되는 보안 토큰을 발행해 토큰 값 일치 여부에 따라 요청이 동작하도록 구현

**우회 기법**

* 토큰 발급 페이지에 접근한 후 토큰 값을 획득해 요청을 보내면 정상 요청으로 판단하여 우회가 가능하다.

<br>

### 추가 인증 (보안 강도 우수)

**보안 기법**

* 중요 기능에 대해 2차, 3차의 추가 인증을 필수적으로 수행하도록 구현한다.
* 비밀번호 입력, 휴대전화 인증, Captcha 등으로 동작 행위자만 수행할 수 있는 인증을 추가로 구현한다.
* 이는 보안성이 뛰어나지만 사용자의 편의성이 떨어진다.

<br>


--- 

#### ref

* [사이트 간 스크립팅](https://ko.wikipedia.org/wiki/%EC%82%AC%EC%9D%B4%ED%8A%B8_%EA%B0%84_%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8C%85)
* [웹 취약점과 해킹 매커니즘#7 XSS(Cross-Site Scripting) - 개념](https://blog.naver.com/sk_shieldus/222902533919)
* [[Special Report] 웹 취약점과 해킹 매커니즘#9 CSRF(Cross-Site Request Forgery)](https://blog.naver.com/sk_shieldus/222985847567)
